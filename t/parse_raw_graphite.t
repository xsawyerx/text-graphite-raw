#!perl

use strict;
use warnings;
use Test::More tests => 10;
use Text::Graphite::Raw;

my $data = q{kitteh.scratch.overall,1377597018,1377597118,1|317.0,351.0,338.0,369.0,349.0,350.0,340.0,347.0,343.0,326.0,339.0,332.0,344.0,347.0,340.0,350.0,337.0,341.0,353.0,354.0,353.0,338.0,331.0,319.0,328.0,341.0,379.0,343.0,338.0,326.0,339.0,332.0,358.0,322.0,324.0,327.0,325.0,337.0,359.0,341.0,351.0,320.0,334.0,339.0,361.0,333.0,332.0,351.0,351.0,342.0,349.0,337.0,349.0,347.0,329.0,359.0,315.0,354.0,315.0,350.0,331.0,329.0,330.0,344.0,331.0,366.0,351.0,323.0,340.0,331.0,323.0,352.0,345.0,365.0,327.0,369.0,335.0,345.0,340.0,335.0,342.0,326.0,338.0,337.0,325.0,345.0,326.0,345.0,348.0,363.0,334.0,334.0,350.0,346.0,362.0,350.0,333.0,321.0,340.0,330.0};

# forces these to be as strings
my @points = qw<317.0 351.0 338.0 369.0 349.0 350.0 340.0 347.0 343.0 326.0 339.0 332.0 344.0 347.0 340.0 350.0 337.0 341.0 353.0 354.0 353.0 338.0 331.0 319.0 328.0 341.0 379.0 343.0 338.0 326.0 339.0 332.0 358.0 322.0 324.0 327.0 325.0 337.0 359.0 341.0 351.0 320.0 334.0 339.0 361.0 333.0 332.0 351.0 351.0 342.0 349.0 337.0 349.0 347.0 329.0 359.0 315.0 354.0 315.0 350.0 331.0 329.0 330.0 344.0 331.0 366.0 351.0 323.0 340.0 331.0 323.0 352.0 345.0 365.0 327.0 369.0 335.0 345.0 340.0 335.0 342.0 326.0 338.0 337.0 325.0 345.0 326.0 345.0 348.0 363.0 334.0 334.0 350.0 346.0 362.0 350.0 333.0 321.0 340.0 330.0>;

can_ok( __PACKAGE__, 'parse_raw_graphite' );
my $data = parse_raw_graphite($data);
isa_ok( $data, 'ARRAY' );
cmp_ok( scalar @{$data}, '==', 1, 'Correct number of metrics' );

my ( $label, $from, $until, $step, $metric_data ) = @{ $data->[0] };
is( $label, 'kitteh.scratch.overall', 'Correct label' );
cmp_ok( $from,  '==', 1377597018, 'Correct from'  );
cmp_ok( $until, '==', 1377597118, 'Correct until' );
cmp_ok( $step,  '==', 1,          'Correct step'  );

isa_ok( $metric_data, 'ARRAY' );
cmp_ok( scalar @{$metric_data}, '==', 100, 'Correct number of data points' );
is_deeply( $metric_data, \@points, 'Correct data points' );

